<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–∞–¥–µ–±–Ω–æ–µ —Ñ–æ—Ç–æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial; }
        body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 25px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 8px solid gold; text-align: center; }
        h1 { color: #d63384; margin-bottom: 10px; }
        video, img { width: 100%; border-radius: 15px; display: none; margin: 20px 0; }
        video { background: #000; transform: scaleX(-1); }
        img { border: 5px solid #4CAF50; max-height: 400px; object-fit: cover; }
        .controls { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; }
        button { padding: 18px; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; }
        #startBtn { background: #2196F3; color: white; }
        #captureBtn { background: #FF9800; color: white; display: none; }
        #retakeBtn { background: #757575; color: white; display: none; }
        #saveBtn { background: #4CAF50; color: white; display: none; }
        .status { margin: 20px 0; padding: 15px; border-radius: 10px; display: none; }
        .success { background: #d4edda; color: #155724; border: 2px solid #4CAF50; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíç –°–≤–∞–¥–µ–±–Ω–æ–µ –§–æ—Ç–æ</h1>
        <p style="color: #666; margin-bottom: 20px;">–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ</p>
        
        <video id="video" autoplay playsinline></video>
        <img id="photo" alt="–í–∞—à–µ —Ñ–æ—Ç–æ">
        
        <div class="controls">
            <button id="startBtn">üé• –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="captureBtn">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <button id="retakeBtn">üîÑ –ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
            <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="savedPhotos" style="margin-top: 30px; text-align: left; display: none;">
            <h3>üìÅ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–æ—Ç–æ:</h3>
            <div id="photosList"></div>
        </div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const video = document.getElementById('video');
        const photo = document.getElementById('photo');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const saveBtn = document.getElementById('saveBtn');
        const statusDiv = document.getElementById('status');
        const savedPhotosDiv = document.getElementById('savedPhotos');
        const photosListDiv = document.getElementById('photosList');
        
        let stream = null;
        let photoDataUrl = null;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(text, type) {
            statusDiv.textContent = text;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        // 1. –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
        startBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: false
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                photo.style.display = 'none';
                
                startBtn.style.display = 'none';
                captureBtn.style.display = 'block';
                retakeBtn.style.display = 'none';
                saveBtn.style.display = 'none';
                
                showStatus('üì∏ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞! –£–ª—ã–±–Ω–∏—Ç–µ—Å—å!', 'success');
            } catch (err) {
                showStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É', 'error');
            }
        });
        
        // 2. –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
        captureBtn.addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ Data URL
            photoDataUrl = canvas.toDataURL('image/jpeg', 0.85);
            photo.src = photoDataUrl;
            video.style.display = 'none';
            photo.style.display = 'block';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'block';
            saveBtn.style.display = 'block';
            
            showStatus('‚úÖ –û—Ç–ª–∏—á–Ω–æ–µ —Ñ–æ—Ç–æ! –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.', 'success');
        });
        
        // 3. –ü–µ—Ä–µ—Å–Ω—è—Ç—å
        retakeBtn.addEventListener('click', () => {
            photoDataUrl = null;
            photo.style.display = 'none';
            startBtn.click();
        });
        
        // 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ
        saveBtn.addEventListener('click', () => {
            if (!photoDataUrl) return;
            
            // –°–æ–∑–¥–∞—ë–º ID –¥–ª—è —Ñ–æ—Ç–æ
            const photoId = 'photo_' + Date.now();
            const timestamp = new Date().toLocaleString('ru-RU');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            const photoData = {
                id: photoId,
                time: timestamp,
                dataUrl: photoDataUrl
            };
            
            let savedPhotos = JSON.parse(localStorage.getItem('wedding_photos') || '[]');
            savedPhotos.push(photoData);
            localStorage.setItem('wedding_photos', JSON.stringify(savedPhotos));
            
            showStatus('‚úÖ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ!', 'success');
            
            // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–∫–∞—á–∞—Ç—å
            setTimeout(() => {
                if (confirm('–•–æ—Ç–∏—Ç–µ —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω?')) {
                    const link = document.createElement('a');
                    link.href = photoDataUrl;
                    link.download = `—Å–≤–∞–¥–µ–±–Ω–æ–µ_—Ñ–æ—Ç–æ_${timestamp.replace(/[^\d]/g, '-')}.jpg`;
                    link.click();
                }
            }, 500);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
            showSavedPhotos();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                photo.style.display = 'none';
                startBtn.style.display = 'block';
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'none';
                saveBtn.style.display = 'none';
                showStatus('üì∏ –ì–æ—Ç–æ–≤–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–æ—Ç–æ!', 'success');
            }, 3000);
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
        function showSavedPhotos() {
            const savedPhotos = JSON.parse(localStorage.getItem('wedding_photos') || '[]');
            
            if (savedPhotos.length === 0) return;
            
            savedPhotosDiv.style.display = 'block';
            photosListDiv.innerHTML = '';
            
            savedPhotos.reverse().forEach((photo, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.style.cssText = 'background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 10px;';
                photoDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>–§–æ—Ç–æ ${savedPhotos.length - index}</strong><br>
                            <small>${photo.time}</small>
                        </div>
                        <div>
                            <button onclick="viewPhoto('${photo.id}')" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 5px;">
                                üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                            </button>
                            <button onclick="deletePhoto('${photo.id}')" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
                photosListDiv.appendChild(photoDiv);
            });
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
        window.viewPhoto = function(id) {
            const savedPhotos = JSON.parse(localStorage.getItem('wedding_photos') || '[]');
            const photo = savedPhotos.find(p => p.id === id);
            
            if (photo) {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                const viewer = window.open('', '_blank');
                viewer.document.write(`
                    <html>
                    <head><title>–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ</title>
                    <style>body { font-family: Arial; padding: 20px; text-align: center; } img { max-width: 90%; }</style>
                    </head>
                    <body>
                        <h2>–°–≤–∞–¥–µ–±–Ω–æ–µ —Ñ–æ—Ç–æ</h2>
                        <p>${photo.time}</p>
                        <img src="${photo.dataUrl}" alt="–§–æ—Ç–æ">
                        <br><br>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </body>
                    </html>
                `);
            }
        };
        
        window.deletePhoto = function(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) return;
            
            let savedPhotos = JSON.parse(localStorage.getItem('wedding_photos') || '[]');
            savedPhotos = savedPhotos.filter(p => p.id !== id);
            localStorage.setItem('wedding_photos', JSON.stringify(savedPhotos));
            
            showSavedPhotos();
            showStatus('üóëÔ∏è –§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ!', 'success');
        };
        
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            showStatus('üëã –ù–∞–∂–º–∏ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å', 'success');
            showSavedPhotos();
        });
    </script>
</body>
</html>
