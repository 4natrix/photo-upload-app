<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–∞–¥–µ–±–Ω–æ–µ —Ñ–æ—Ç–æ</title>
    <style>
        /* –°—Ç–∏–ª–∏ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–∏–º–µ—Ä–µ */
        body { font-family: Arial; padding: 20px; text-align: center; }
        .container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        video, img { width: 100%; max-width: 400px; border-radius: 10px; margin: 15px 0; display: none; }
        button { padding: 15px 25px; margin: 10px; border: none; border-radius: 50px; background: #4CAF50; color: white; font-size: 16px; cursor: pointer; }
        #status { margin: 20px 0; padding: 15px; border-radius: 10px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ –§–æ—Ç–æ –Ω–∞ —Å–≤–∞–¥—å–±—É!</h1>
        <p>–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ - –æ–Ω–æ –ø–æ–ø–∞–¥—ë—Ç –≤ –Ω–∞—à –∞–ª—å–±–æ–º</p>
        
        <video id="video" autoplay playsinline></video>
        <img id="photo" alt="–í–∞—à–µ —Ñ–æ—Ç–æ">
        
        <div>
            <button id="startBtn">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="captureBtn" disabled>–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <button id="retakeBtn" disabled>–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
            <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        
        <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width:80%; padding:10px; margin:10px;">
        
        <div id="status"></div>
    </div>

    <script>
        // –ù–ê–°–¢–†–û–ô–ö–ò
        const FORM_SUBMIT_EMAIL = 'chekmachevanatoly15@gmail.com'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π email
        const IMGBB_API_KEY = '926d95b5c1a2a5d2e7b7473c7c7c7c7c'; // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á (—Ä–∞–±–æ—á–∏–π)
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const video = document.getElementById('video');
        const photo = document.getElementById('photo');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const sendBtn = document.getElementById('sendBtn');
        const nameInput = document.getElementById('name');
        const statusDiv = document.getElementById('status');
        
        let stream = null;
        let photoBlob = null;
        
        // 1. –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
        startBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' },
                    audio: false 
                });
                video.srcObject = stream;
                video.style.display = 'block';
                photo.style.display = 'none';
                
                startBtn.disabled = true;
                captureBtn.disabled = false;
                showStatus('üì∏ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞! –£–ª—ã–±–Ω–∏—Ç–µ—Å—å!', 'success');
            } catch (err) {
                showStatus('‚ùå –ù–µ –º–æ–≥—É –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'error');
            }
        });
        
        // 2. –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
        captureBtn.addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è selfie
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ blob
            canvas.toBlob(blob => {
                photoBlob = blob;
                photo.src = URL.createObjectURL(blob);
                video.style.display = 'none';
                photo.style.display = 'block';
                
                captureBtn.disabled = true;
                retakeBtn.disabled = false;
                sendBtn.disabled = false;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                showStatus('‚úÖ –û—Ç–ª–∏—á–Ω–æ–µ —Ñ–æ—Ç–æ! –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å.', 'success');
            }, 'image/jpeg', 0.85);
        });
        
        // 3. –ü–µ—Ä–µ—Å–Ω—è—Ç—å
        retakeBtn.addEventListener('click', () => {
            photoBlob = null;
            photo.style.display = 'none';
            photo.src = '';
            startBtn.disabled = false;
            captureBtn.disabled = true;
            retakeBtn.disabled = true;
            sendBtn.disabled = true;
            startBtn.click();
        });
        
        // 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ (–û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø)
        sendBtn.addEventListener('click', async () => {
            if (!photoBlob) return;
            
            const guestName = nameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º–Ω—ã–π –≥–æ—Å—Ç—å';
            const timestamp = new Date().toLocaleString('ru-RU');
            
            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            showStatus('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ...', 'success');
            
            try {
                // –®–∞–≥ 1: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –Ω–∞ ImgBB
                const imgbbFormData = new FormData();
                imgbbFormData.append('image', photoBlob);
                
                const imgbbResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: imgbbFormData
                });
                
                const imgbbData = await imgbbResponse.json();
                
                if (!imgbbData.success) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
                }
                
                const photoUrl = imgbbData.data.url;
                
                // –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ FormSubmit
                const formData = new FormData();
                formData.append('–ò–º—è –≥–æ—Å—Ç—è', guestName);
                formData.append('–í—Ä–µ–º—è', timestamp);
                formData.append('–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ', photoUrl);
                formData.append('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', navigator.userAgent.substring(0, 100));
                
                // –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è FormSubmit
                formData.append('_subject', `üéâ –ù–æ–≤–æ–µ —Å–≤–∞–¥–µ–±–Ω–æ–µ —Ñ–æ—Ç–æ –æ—Ç ${guestName}`);
                formData.append('_template', 'table');
                formData.append('_captcha', 'false');
                
                await fetch(`https://formsubmit.co/ajax/${FORM_SUBMIT_EMAIL}`, {
                    method: 'POST',
                    body: formData
                });
                
                // –£—Å–ø–µ—Ö!
                showStatus('üéâ –£—Ä–∞! –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Å–≤–∞–¥–µ–±–Ω—ã–π –∞–ª—å–±–æ–º!', 'success');
                
                // –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                }, 3000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showStatus('‚ö†Ô∏è –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞', 'success');
                
                // –í—Å–µ —Ä–∞–≤–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                setTimeout(() => {
                    location.reload();
                }, 3000);
            }
        });
        
        function showStatus(msg, type) {
            statusDiv.textContent = msg;
            statusDiv.className = type;
            statusDiv.style.display = 'block';
        }
        
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            showStatus('üëÜ –ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å', 'success');
        });
    </script>
</body>
</html>
