<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–∞–¥–µ–±–Ω–æ–µ —Ñ–æ—Ç–æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial; }
        body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 25px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 8px solid gold; text-align: center; }
        h1 { color: #d63384; margin-bottom: 10px; }
        video, img { width: 100%; border-radius: 15px; display: none; }
        video { background: #000; transform: scaleX(-1); }
        img { border: 5px solid #4CAF50; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0; }
        button { padding: 18px; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #startBtn { background: #2196F3; color: white; grid-column: span 2; }
        #captureBtn { background: #FF9800; color: white; display: none; }
        #retakeBtn { background: #757575; color: white; display: none; }
        #sendBtn { background: #4CAF50; color: white; grid-column: span 2; display: none; }
        .status { margin: 20px 0; padding: 15px; border-radius: 10px; font-weight: bold; display: none; }
        .success { background: #d4edda; color: #155724; border: 2px solid #4CAF50; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíç –°–≤–∞–¥–µ–±–Ω–æ–µ –§–æ—Ç–æ</h1>
        
        <video id="video" autoplay playsinline></video>
        <img id="photo" alt="–í–∞—à–µ —Ñ–æ—Ç–æ">
        
        <div class="controls">
            <button id="startBtn">üé• –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="captureBtn">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <button id="retakeBtn">üîÑ –ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
            <button id="sendBtn">‚úàÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
        </div>
        
        <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width:100%; padding:15px; margin:10px 0; border-radius:50px; border:3px solid #FFD700; display:none;">
        
        <div id="status" class="status"></div>
        
        <p style="color: #666; font-size: 14px; margin-top: 20px;">
            –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.<br>
            –ß—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ–∑–∂–µ.
        </p>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const video = document.getElementById('video');
        const photo = document.getElementById('photo');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const sendBtn = document.getElementById('sendBtn');
        const nameInput = document.getElementById('name');
        const statusDiv = document.getElementById('status');
        
        let stream = null;
        let photoBlob = null;
        let photoDataUrl = null;
        
        // –§—É–Ω–∫—Ü–∏–∏
        function showStatus(text, type) {
            statusDiv.textContent = text;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        // 1. –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
        startBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: false
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                photo.style.display = 'none';
                
                startBtn.style.display = 'none';
                captureBtn.style.display = 'flex';
                nameInput.style.display = 'none';
                
                showStatus('üì∏ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞! –£–ª—ã–±–Ω–∏—Ç–µ—Å—å!', 'success');
            } catch (err) {
                showStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É', 'error');
            }
        });
        
        // 2. –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
        captureBtn.addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ Data URL –∏ Blob
            photoDataUrl = canvas.toDataURL('image/jpeg', 0.85);
            canvas.toBlob(blob => {
                photoBlob = blob;
                photo.src = photoDataUrl;
                video.style.display = 'none';
                photo.style.display = 'block';
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'flex';
                sendBtn.style.display = 'flex';
                nameInput.style.display = 'block';
                
                showStatus('‚úÖ –û—Ç–ª–∏—á–Ω–æ–µ —Ñ–æ—Ç–æ! –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.', 'success');
            }, 'image/jpeg', 0.85);
        });
        
        // 3. –ü–µ—Ä–µ—Å–Ω—è—Ç—å
        retakeBtn.addEventListener('click', () => {
            photoBlob = null;
            photoDataUrl = null;
            photo.style.display = 'none';
            nameInput.style.display = 'none';
            startBtn.click();
        });
        
        // 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ
        sendBtn.addEventListener('click', async () => {
            if (!photoBlob || !photoDataUrl) return;
            
            const guestName = nameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º–Ω—ã–π –≥–æ—Å—Ç—å';
            const timestamp = new Date().toLocaleString('ru-RU');
            const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º...';
            showStatus('üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ...', 'success');
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                const photoData = {
                    id: photoId,
                    name: guestName,
                    time: timestamp,
                    photoDataUrl: photoDataUrl,
                    device: navigator.userAgent.substring(0, 100),
                    date: new Date().toISOString()
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ñ–æ—Ç–æ
                let allPhotos = JSON.parse(localStorage.getItem('wedding_photos') || '[]');
                allPhotos.push(photoData);
                localStorage.setItem('wedding_photos', JSON.stringify(allPhotos));
                
                // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                const viewUrl = window.location.origin + '/view.html#' + photoId;
                
                // –ï—Å–ª–∏ –Ω–∞ GitHub Pages
                if (window.location.hostname.includes('github.io')) {
                    const viewUrl = window.location.href.replace('index.html', 'view.html') + '#' + photoId;
                }
                
                // –£–°–ü–ï–•
                showStatus('‚úÖ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
                setTimeout(() => {
                    const message = `üíæ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!\n\nüë∞ –ò–º—è: ${guestName}\nüìÖ –í—Ä–µ–º—è: ${timestamp}\n\nüîó –°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:\n${viewUrl}\n\nüìå –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∂–µ.`;
                    
                    if (confirm(message + '\n\n–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ —Å–µ–π—á–∞—Å?')) {
                        window.open(viewUrl, '_blank');
                    }
                }, 500);
                
                // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ
                setTimeout(() => {
                    if (confirm('–•–æ—Ç–∏—Ç–µ —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω?')) {
                        const link = document.createElement('a');
                        link.href = photoDataUrl;
                        link.download = `—Å–≤–∞–¥–µ–±–Ω–æ–µ_—Ñ–æ—Ç–æ_${guestName}_${timestamp.replace(/[^\d]/g, '-')}.jpg`;
                        link.click();
                    }
                }, 1000);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                setTimeout(() => {
                    location.reload();
                }, 5000);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                sendBtn.disabled = false;
                sendBtn.innerHTML = '‚úàÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
            }
        });
        
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            showStatus('üëã –ù–∞–∂–º–∏ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å', 'success');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
            const savedPhotos = JSON.parse(localStorage.getItem('wedding_photos') || '[]');
            if (savedPhotos.length > 0) {
                const info = document.createElement('p');
                info.style.color = '#666';
                info.style.fontSize = '14px';
                info.style.marginTop = '10px';
                info.textContent = `üìä –£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Ñ–æ—Ç–æ: ${savedPhotos.length}`;
                statusDiv.parentNode.insertBefore(info, statusDiv.nextSibling);
            }
        });
    </script>
</body>
</html>
